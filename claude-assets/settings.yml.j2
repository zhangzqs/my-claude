# settings.yml.j2
# 用于渲染 claude settings 的 YAML 模板
# 所有可配置变量均从 inventory/default/group_vars/all/settings.yml 传入

schema: "https://json.schemastore.org/claude-code-settings.json"

# ===== 环境变量 =====
env:
{% for key, value in settings.env.items() %}
  {{ key }}: "{{ value }}"
{% endfor %}
  ANTHROPIC_API_KEY: "{{ secrets.settings.env.ANTHROPIC_API_KEY }}"

# ===== 模型配置 =====
model: "{{ settings.model }}"
alwaysThinkingEnabled: {{ settings.alwaysThinkingEnabled | lower }}

# ===== 输出风格与语言 =====
outputStyle: "{{ settings.outputStyle }}"
{% if settings.language is defined and settings.language %}
language: "{{ settings.language }}"
{% endif %}

# ===== 权限配置 =====
permissions:
{% if settings.permissions.defaultMode is defined and settings.permissions.defaultMode != "default" %}
  defaultMode: "{{ settings.permissions.defaultMode }}"
{% endif %}
  allow:
{% for tool in settings.permissions.allow %}
    - {{ tool }}
{% endfor %}
{% if settings.permissions.deny | length > 0 %}
  deny:
{% for rule in settings.permissions.deny %}
    - {{ rule }}
{% endfor %}
{% else %}
  deny: []
{% endif %}

# ===== Git 归属配置（不添加 Claude 署名） =====
attribution:
  commit: ""
  pr: ""

# ===== 会话与存储 =====
cleanupPeriodDays: {{ settings.cleanupPeriodDays }}

# ===== 状态行 =====
statusLine:
  type: command
  command: ccline
  padding: 0

# ===== Hooks 钩子 =====
{% if settings.hooks | length > 0 %}
hooks:
{{ settings.hooks | to_nice_yaml | indent(2, first=true) }}
{% else %}
hooks: {}
{% endif %}
{% if settings.enabled_plugins is defined and settings.enabled_plugins | length > 0 %}

# ===== Claude 插件启用配置 =====
enabledPlugins:
{% for plugin in settings.enabled_plugins %}
  {{ plugin }}: true
{% endfor %}
{% endif %}
{% if settings.custom_mcp_servers is defined and settings.custom_mcp_servers | length > 0 %}

# ===== 自定义 MCP 服务器配置 =====
mcpServers:
{% for server in settings.custom_mcp_servers %}
  {{ server.name }}:
    command: {{ server.command }}
    args:
{% for arg in server.args %}
      - {{ arg }}
{% endfor %}
{% if server.env is defined %}
    env:
{% for key, value in server.env.items() %}
      {{ key }}: {{ value }}
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}
