---
- name: 渲染 claude settings.json 配置文件
  hosts: localhost
  gather_facts: false
  tasks:
    - name: 创建 ~/.claude 目录（如不存在）
      file: { path: "~/.claude", state: directory, mode: "0755" }

    - name: 渲染 claude settings.yml
      template:
        src: "{{ playbook_dir }}/../claude-assets/settings.yml.j2"
        dest: "/tmp/claude_settings.yml"
        mode: "0644"

    - name: 读取渲染后的 YAML
      slurp:
        src: "/tmp/claude_settings.yml"
      register: settings_yml_content

    - name: 解析 YAML 并转为 JSON
      copy:
        dest: "~/.claude/settings.json"
        content: "{{ settings_yml_content.content | b64decode | from_yaml | to_nice_json }}"
        mode: "0644"

    - name: rsync 同步 output-styles 目录
      synchronize:
        src: "{{ playbook_dir }}/../claude-assets/output-styles/"
        dest: "~/.claude/output-styles/"
        recursive: yes
        mode: push
        delete: no

    - name: rsync 同步 commands 目录
      synchronize:
        src: "{{ playbook_dir }}/../claude-assets/commands/"
        dest: "~/.claude/commands/"
        recursive: yes
        mode: push
        delete: no

    - name: 拷贝 CLAUDE.md 文件
      copy:
        dest: "~/.claude/CLAUDE.md"
        src: "{{ playbook_dir }}/../claude-assets/CLAUDE.md"
        mode: "0644"
