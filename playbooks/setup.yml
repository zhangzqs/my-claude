---
# playbooks/setup.yml
# Claude Code 完整配置部署（编排层）
#
# 功能：
# 1. 检查 Claude CLI 是否已安装
# 2. 自动安装 enabled_plugins 列表中的插件
# 3. 同步配置到 ~/.claude/settings.json
# 4. 验证部署结果
#
# 使用方法：
#   # 单机部署（默认）
#   uv run ansible-playbook playbooks/setup.yml
#
#   # 部署到指定主机组
#   uv run ansible-playbook playbooks/setup.yml -e "target_hosts=dev"
#
#   # 部署到所有主机
#   uv run ansible-playbook playbooks/setup.yml -e "target_hosts=all"
#
# 跳过特定阶段：
#   uv run ansible-playbook playbooks/setup.yml --skip-tags install_cli
#   uv run ansible-playbook playbooks/setup.yml --skip-tags install_plugins
#   uv run ansible-playbook playbooks/setup.yml --skip-tags sync_config
#   uv run ansible-playbook playbooks/setup.yml --skip-tags verify
#
# 仅执行特定阶段：
#   uv run ansible-playbook playbooks/setup.yml --tags install_plugins
#   uv run ansible-playbook playbooks/setup.yml --tags sync_config

- name: Claude Code 完整配置部署
  hosts: "{{ target_hosts | default('localhost') }}"
  gather_facts: false

  vars:
    # 从 settings.yml 读取配置
    plugins_to_install: "{{ settings.enabled_plugins | default([]) }}"

  tasks:
    - name: ===== 阶段 1：检查 Claude CLI =====
      include_tasks: tasks/check_cli.yml
      tags:
        - always
        - install_cli

    - name: ===== 阶段 2：安装插件 =====
      include_tasks: tasks/install_plugins_tasks.yml
      tags:
        - install_plugins

    - name: ===== 阶段 3：同步配置 =====
      include_tasks: tasks/sync_config_tasks.yml
      tags:
        - sync_config

    - name: ===== 阶段 4：验证部署 =====
      include_tasks: tasks/verify_deployment.yml
      tags:
        - verify

    - name: 最终部署报告
      debug:
        msg: |
          ========================================
          ✓ Claude Code 部署完成
          ========================================

          部署摘要：
          - 目标主机：{{ inventory_hostname }}
          - Claude CLI：已安装
          - 插件数量：{{ plugins_to_install | length }} 个
          - 配置文件：~/.claude/settings.json
          - 输出风格：{{ settings.outputStyle }}

          已启用的插件：
          {% for plugin in plugins_to_install %}
          - {{ plugin }}
          {% endfor %}

          下一步：
          1. 重启 Claude Code 会话以加载新配置
          2. 验证插件工具是否可用

          验证命令：
          - claude plugin list          # 查看已安装插件
          - cat ~/.claude/settings.json # 检查配置文件
      tags:
        - always
