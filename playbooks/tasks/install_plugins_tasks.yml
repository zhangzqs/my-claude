---
# playbooks/tasks/install_plugins_tasks.yml
# 安装 Claude 插件

- name: 显示阶段信息
  debug:
    msg: |
      ========================================
      阶段 2：安装插件
      ========================================
      期望插件数量：{{ plugins_to_install | length }}

- name: 检查是否配置了插件
  debug:
    msg: "⚠️  未配置任何插件，跳过插件安装"
  when: plugins_to_install | length == 0

- name: 提取目标插件使用的 marketplace 列表
  set_fact:
    plugin_marketplaces_required: >-
      {{
        plugins_to_install
        | select('search', '@')
        | map('regex_replace', '^.*@', '')
        | unique
        | list
      }}
  when: plugins_to_install | length > 0

- name: 获取已配置 marketplace 列表
  shell: claude plugin marketplace list --json 2>/dev/null || echo '[]'
  register: configured_marketplaces_raw
  changed_when: false
  failed_when: false
  when: plugins_to_install | length > 0

- name: 解析已配置 marketplace 列表
  set_fact:
    configured_marketplaces: "{{ configured_marketplaces_raw.stdout | from_json | default([]) }}"
  when: plugins_to_install | length > 0

- name: 提取已配置 marketplace 名称
  set_fact:
    configured_marketplace_names: "{{ configured_marketplaces | map(attribute='name') | list }}"
  when: plugins_to_install | length > 0

- name: 自动添加官方 marketplace
  command: "claude plugin marketplace add https://github.com/anthropics/claude-plugins-official.git"
  register: add_official_marketplace
  changed_when: add_official_marketplace.rc == 0
  failed_when: add_official_marketplace.rc != 0
  when:
    - plugins_to_install | length > 0
    - "'claude-plugins-official' in plugin_marketplaces_required"
    - "'claude-plugins-official' not in configured_marketplace_names"

- name: 更新官方 marketplace 索引
  command: "claude plugin marketplace update claude-plugins-official"
  register: update_official_marketplace
  changed_when: false
  failed_when: false
  when:
    - plugins_to_install | length > 0
    - "'claude-plugins-official' in plugin_marketplaces_required"

- name: 获取已安装插件列表
  shell: claude plugin list --json 2>/dev/null || echo '[]'
  register: installed_plugins_raw
  changed_when: false
  failed_when: false
  when: plugins_to_install | length > 0

- name: 解析已安装插件列表
  set_fact:
    installed_plugins: "{{ installed_plugins_raw.stdout | from_json | default([]) }}"
  when: plugins_to_install | length > 0

- name: 提取已安装插件 ID
  set_fact:
    installed_plugin_ids: "{{ installed_plugins | map(attribute='id') | list }}"
  when:
    - plugins_to_install | length > 0
    - installed_plugins | length > 0

- name: 初始化已安装插件列表（空）
  set_fact:
    installed_plugin_ids: []
  when:
    - plugins_to_install | length > 0
    - installed_plugins | length == 0

- name: 计算需要安装的插件
  set_fact:
    plugins_to_add: "{{ plugins_to_install | difference(installed_plugin_ids) }}"
  when: plugins_to_install | length > 0

- name: 显示插件安装计划
  debug:
    msg: |
      已安装：{{ installed_plugin_ids }}
      需要安装：{{ plugins_to_add }}
  when: plugins_to_install | length > 0

- name: 提示无需安装插件
  debug:
    msg: "✓ 所有插件已安装，跳过安装"
  when:
    - plugins_to_install | length > 0
    - plugins_to_add | length == 0

- name: 安装缺失的插件
  command: "claude plugin install {{ item }}"
  loop: "{{ plugins_to_add }}"
  register: install_result
  when:
    - plugins_to_install | length > 0
    - plugins_to_add | length > 0
  changed_when: install_result.rc == 0
  failed_when: install_result.rc != 0

- name: 等待插件安装完成
  pause:
    seconds: 2
  when:
    - plugins_to_install | length > 0
    - plugins_to_add | length > 0

- name: 验证插件安装结果
  shell: claude plugin list --json 2>/dev/null || echo '[]'
  register: installed_plugins_after
  changed_when: false
  when:
    - plugins_to_install | length > 0
    - plugins_to_add | length > 0

- name: 解析安装后的插件列表
  set_fact:
    installed_plugins_final: "{{ installed_plugins_after.stdout | from_json | default([]) }}"
    installed_plugin_ids_final: "{{ (installed_plugins_after.stdout | from_json | default([])) | map(attribute='id') | list }}"
  when:
    - plugins_to_install | length > 0
    - plugins_to_add | length > 0

- name: 检查插件是否安装成功
  assert:
    that:
      - item in installed_plugin_ids_final
    fail_msg: "插件 {{ item }} 安装失败"
    success_msg: "插件 {{ item }} 安装成功"
  loop: "{{ plugins_to_install }}"
  when:
    - plugins_to_install | length > 0
    - plugins_to_add | length > 0

- name: 显示插件安装完成信息
  debug:
    msg: |
      ✓ 插件安装完成
      已安装插件数量：{{ installed_plugin_ids_final | length }}
  when:
    - plugins_to_install | length > 0
    - plugins_to_add | length > 0
