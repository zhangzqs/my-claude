---
# playbooks/tasks/check_cli.yml
# 检查 Claude CLI 是否已安装

- name: 显示阶段信息
  debug:
    msg: |
      ========================================
      阶段 1：检查 Claude CLI
      ========================================

- name: 检查 Claude CLI 是否已安装
  shell: which claude || command -v claude
  register: claude_check
  changed_when: false
  failed_when: false

- name: 显示 Claude CLI 状态
  debug:
    msg: "{{ 'Claude CLI 已安装：' + claude_check.stdout if claude_check.rc == 0 else 'Claude CLI 未安装' }}"

- name: 提示需要安装 Claude CLI
  debug:
    msg: |
      ⚠️  Claude CLI 未安装

      请选择安装方式：
      1. 自动安装（推荐）：
         uv run ansible-playbook playbooks/install_claude.yml

      2. 手动安装：
         npm install -g @anthropics/claude-code

      安装完成后，重新运行此 Playbook。
  when: claude_check.rc != 0

- name: 终止部署（Claude CLI 未安装）
  fail:
    msg: "Claude CLI 未安装，无法继续部署。请先安装 Claude CLI。"
  when: claude_check.rc != 0
