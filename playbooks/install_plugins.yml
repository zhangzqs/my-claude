---
# playbooks/install_plugins.yml
# 自动安装 Claude 插件
#
# 功能：
# 1. 检测 enabled_plugins 列表中的插件是否已安装
# 2. 自动安装缺失的插件
# 3. 确保幂等性（重复执行不会重复安装）
#
# 使用方法：
#   uv run ansible-playbook playbooks/install_plugins.yml
#
# 前置条件：
#   - Claude CLI 已安装（通过 install_claude.yml 安装）
#   - enabled_plugins 已在 settings.yml 中配置

- name: 自动安装 Claude 插件
  hosts: localhost
  gather_facts: false

  vars:
    # 从 settings.yml 读取插件列表
    plugins_to_install: "{{ settings.enabled_plugins | default([]) }}"

  tasks:
    - name: 检查 Claude CLI 是否已安装
      shell: which claude || command -v claude
      register: claude_check
      changed_when: false
      failed_when: false

    - name: 验证 Claude CLI 可用性
      fail:
        msg: |
          Claude CLI 未安装或不在 PATH 中。
          请先运行：ansible-playbook playbooks/install_claude.yml
      when: claude_check.rc != 0

    - name: 显示将要处理的插件列表
      debug:
        msg: "期望启用的插件数量：{{ plugins_to_install | length }}"

    - name: 检查是否有插件需要处理
      fail:
        msg: |
          settings.yml 中未配置任何插件。
          请在 inventory/default/group_vars/all/settings.yml 中配置 enabled_plugins。
      when: plugins_to_install | length == 0

    - name: 获取已安装插件列表（JSON 格式）
      shell: claude plugin list --json 2>/dev/null || echo '[]'
      register: installed_plugins_raw
      changed_when: false
      failed_when: false

    - name: 解析已安装插件列表
      set_fact:
        installed_plugins: "{{ installed_plugins_raw.stdout | from_json | default([]) }}"

    - name: 提取已安装插件的 ID 列表（格式：name@marketplace）
      set_fact:
        installed_plugin_ids: "{{ installed_plugins | map(attribute='id') | list }}"
      when: installed_plugins | length > 0

    - name: 初始化已安装插件列表（无插件时）
      set_fact:
        installed_plugin_ids: []
      when: installed_plugins | length == 0

    - name: 显示已安装插件
      debug:
        msg: "已安装的插件：{{ installed_plugin_ids }}"

    - name: 计算需要安装的插件
      set_fact:
        plugins_to_add: "{{ plugins_to_install | difference(installed_plugin_ids) }}"

    - name: 显示需要安装的插件
      debug:
        msg: "需要安装的插件：{{ plugins_to_add }}"

    - name: 提示没有新插件需要安装
      debug:
        msg: "✓ 所有插件已安装，无需执行安装操作"
      when: plugins_to_add | length == 0

    - name: 安装缺失的插件
      command: "claude plugin install {{ item }}"
      loop: "{{ plugins_to_add }}"
      register: install_result
      when: plugins_to_add | length > 0
      changed_when: install_result.rc == 0
      failed_when: install_result.rc != 0

    - name: 等待插件安装完成
      pause:
        seconds: 2
      when: plugins_to_add | length > 0

    - name: 重新获取已安装插件列表（验证）
      shell: claude plugin list --json 2>/dev/null || echo '[]'
      register: installed_plugins_after
      changed_when: false
      when: plugins_to_add | length > 0

    - name: 验证插件安装结果
      block:
        - name: 解析安装后的插件列表
          set_fact:
            installed_plugins_final: "{{ installed_plugins_after.stdout | from_json | default([]) }}"

        - name: 提取安装后的插件 ID 列表
          set_fact:
            installed_plugin_ids_final: "{{ installed_plugins_final | map(attribute='id') | list }}"

        - name: 检查是否所有插件都已成功安装
          assert:
            that:
              - item in installed_plugin_ids_final
            fail_msg: "插件 {{ item }} 安装失败"
            success_msg: "插件 {{ item }} 安装成功"
          loop: "{{ plugins_to_install }}"

        - name: 显示安装成功信息
          debug:
            msg: |
              ✓ 所有插件安装成功！
              已安装插件数量：{{ installed_plugin_ids_final | length }}

      when: plugins_to_add | length > 0

    - name: 显示完成信息
      debug:
        msg: |
          ========================================
          插件安装任务完成
          ========================================

          期望插件数量：{{ plugins_to_install | length }}
          新安装插件数量：{{ plugins_to_add | length }}

          下一步操作：
          1. 运行 sync_claude_config.yml 同步配置到 ~/.claude/settings.json
             uv run ansible-playbook playbooks/sync_claude_config.yml

          2. 在 Claude Code 中验证插件可用性
